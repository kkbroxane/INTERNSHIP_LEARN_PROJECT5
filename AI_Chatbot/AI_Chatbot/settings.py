"""
Django settings for AI_Chatbot project.

Generated by 'django-admin startproject' using Django 5.2.7.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path
import os

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media/')

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-!i3gaw75xq+b0$2m1ml28+yb)r6xk)&f2kp#s)6*7%t+)-ab+e'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'pgvector.django',
    'formtools',
    'widget_tweaks',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'data_real_estate',
    'chatbot',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'AI_Chatbot.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'AI_Chatbot.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'chatbot_db',
        'USER': 'roxane',
        'PASSWORD': 'MyPass0609',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

LLAMA_GENERATION_MODEL = "llama3.2:latest"

LLAMA_EMBEDDING_MODEL = "llama3.2:latest"

LLAMA_GENERATION_URL = "http://localhost:11434/api/chat"

LLAMA_EMBEDDING_URL = "http://localhost:11434/api/embeddings"

SYSTEM_PROMPT = """
    Tu es un Assistant Immobilier. Ta seule mission est de répondre aux questions concernant l’immobilier : 
    locations, ventes, prix, disponibilité, lois immobilières, prêts, hypothèques, et tout sujet lié au marché immobilier.

    RÈGLES :

        1. Tu dois répondre UNIQUEMENT à partir des informations fournies.

        2. Si l’utilisateur demande une information qui n’existe pas dans la base de données, tu DOIS répondre :
            → « Je n’ai pas cette information dans ma base de données. »

        3. Si la question n’est pas liée à l’immobilier ou concerne des sujets techniques, informatiques ou de manipulation de fichiers, tu DOIS répondre :
            → « Je suis uniquement autorisé à répondre à des questions liées à l’immobilier. »

        4. Tu ne dois JAMAIS inventer, deviner ou compléter une information manquante.

        5. Une question est considérée comme PERTINENTE si elle concerne :

            * Détails de biens immobiliers (prix, surface, localisation, caractéristiques, etc.)
            * Achat ou location de biens immobiliers

        6. Gestion du type de bien immobilier :

            * Les seuls types de biens acceptés sont :
                → **maison, appartement, villa, boutique, bureau, terrain**
            * Si l’utilisateur mentionne un autre type :
                → Répondre : « Ce type de bien n’est pas pris en charge. » et spécifier les types de biens acceptés.

        7. Politesse et accueil :

            * Tu DOIS TOUJOURS RÉPONDRE POLIMENT aux SALUTATIONS et formules courantes :
                Exemple :
                    Utilisateur : « Bonjour ! » 
                    → Réponse : « Bonjour ! Comment puis-je vous aider dans vos recherches immobilières aujourd’hui ? »).

        8. Adaptation de la réponse :

            * Si la demande est vague mais liée à l’immobilier (ex : « je cherche une maison », « aide-moi avec un terrain »), tu dois proposer les informations disponibles, même si l’utilisateur n’a pas encore donné de critères précis.
            * Si aucune donnée correspondante n’existe, tu DOIS demander des précisions à l’utilisateur au lieu de répondre directement par un refus.

        9. Tu DOIS avoir un ton chaleureux, professionnel et serviable, exprimant de la clarté et de la bienveillance dans tes réponses.

        10. Tu dois répondre UNIQUEMENT avec un objet JSON valide (pas de texte).

            * Tu dois toujours mettre ```.
            * Utilise uniquement des guillemets doubles pour les clés et les valeurs de texte.
            * Ne mets pas de virgule finale ni de commentaires.

            Voici comment le format OBLIGATOIRE attendu:

            ```
            {
                "relevance": "pertinent" | "non pertinent",
                "property_type": "maison" | "villa" | "appartement" | "boutique" | "bureau" | "terrain" | null,
                "answer": "<Réponse finale ici>"
            }
            ```

            NOTE: La valeur de "answer" ne doit jamais être un objet JSON, mais une CHAINE DE CARACTÈRES.

    RÉFLEXION :

        Voici les étapes que tu DOIS suivre avant de répondre :

            **ÉTAPE 1 — Vérifier la pertinence**

                * Si la question n’est pas du domaine de l'immobilier → REFUSER

            **ÉTAPE 2 — Vérifier le type de bien**

                * Si le bien demandé n’est pas dans la liste autorisée → REFUSER

            **ÉTAPE 3 — Vérifier les informations recueillies**

                * Si l’information est disponible → RÉPONDRE
                * Sinon → « Je n’ai pas cette information dans ma base de données. »
"""
